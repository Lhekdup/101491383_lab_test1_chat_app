<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Chat</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="m-0">Room Chat</h4>
    <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
  </div>

  <div class="mb-2">
    <div><strong>User:</strong> <span id="userLabel"></span></div>
    <div><strong>Room:</strong> <span id="roomLabel"></span></div>
  </div>

  <div id="typing" class="text-muted mb-2" style="height: 20px;"></div>

  <div id="messages" class="border rounded p-3 bg-white mb-3"
       style="height: 320px; overflow-y: auto;">
  </div>

  <div class="input-group">
    <input id="msg" class="form-control" placeholder="Type a message..." />
    <button class="btn btn-primary" onclick="sendMessage()">Send</button>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  const username = localStorage.getItem("username");
  const room = localStorage.getItem("room");

  if (!username) window.location = "login.html";
  if (!room) window.location = "rooms.html";

  document.getElementById("userLabel").textContent = username;
  document.getElementById("roomLabel").textContent = room;

  socket.emit("joinRoom", room);

  function addMessage(text) {
    const messagesDiv = document.getElementById("messages");
    const el = document.createElement("div");
    el.className = "mb-2";
    el.textContent = text;
    messagesDiv.appendChild(el);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  function sendMessage() {
    const input = document.getElementById("msg");
    const message = input.value.trim();
    if (!message) return;

    socket.emit("chatMessage", {
      username,
      room,
      message
    });

    input.value = "";
    document.getElementById("typing").textContent = "";
  }

  socket.on("message", (data) => {
    addMessage(`${data.username}: ${data.message}`);
  });

  let typingTimer;
  socket.on("typing", (typingUser) => {
    const typingDiv = document.getElementById("typing");
    typingDiv.textContent = `${typingUser} is typing...`;

    clearTimeout(typingTimer);
    typingTimer = setTimeout(() => {
      typingDiv.textContent = "";
    }, 1000);
  });

  document.getElementById("msg").addEventListener("input", () => {
    socket.emit("typing", { username, room });
  });

  function logout() {
    localStorage.clear();
    socket.disconnect();
    window.location = "login.html";
  }
</script>

</body>
</html>
